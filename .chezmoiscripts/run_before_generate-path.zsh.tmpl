#!/usr/bin/env zsh
# ChezMoi script: .chezmoiscripts/run_before_generate-path.zsh.tmpl
# Dynamically generates environment.d config to add local bin directories to PATH.

mkdir -p "{{ .chezmoi.sourceDir }}/.config/environment.d"

echo ""
echo "==============================================================="
echo "chezmoi: INFO: Regenerating .config/environment.d/99-env.conf..."

dynamic_part="${(j.:.)${(f)$(find $HOME/.local/bin -type d -printf '%p\\n')}}"

typeset -U path_array
path_array=(${(s.:.)$dynamic_part})
valid_paths=()
for p in $path_array; do
  [[ -d "$p" ]] && valid_paths+="$p"
done
dynamic_part="${(j.:.)valid_paths}"

{
  echo "# Autogenerated by ChezMoi run_before script"
  echo "PATH=\\"$PATH:$dynamic_part\\""
} > "{{ .chezmoi.sourceDir }}/.config/environment.d/99-env.conf"

echo "chezmoi: SUCCESS: Generated .config/environment.d/99-env.conf."
echo "==============================================================="

